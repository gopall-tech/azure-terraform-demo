trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  # THESE MATCH THE RESOURCES YOU JUST CREATED
  bk_resource_group: 'gopal-terraform-backend'
  bk_storage_account: 'gopalstgbackend'
  bk_container_name: 'gopal-tfstate'
  bk_key: 'terraform.tfstate'

steps:
# 1. Create SSH Key for VM
# This prevents the "file not found" error since the agent is fresh every time.
- script: |
    mkdir -p ~/.ssh
    ssh-keygen -m PEM -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
  displayName: 'Generate SSH Key for VMs'

# 2. Install Terraform
- script: |
    sudo apt-get update && sudo apt-get install -y gnupg software-properties-common
    wget -O- https://apt.releases.hashicorp.com/gpg | \
    gpg --dearmor | \
    sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg
    echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] \
    https://apt.releases.hashicorp.com $(lsb_release -cs) main" | \
    sudo tee /etc/apt/sources.list.d/hashicorp.list
    sudo apt-get update && sudo apt-get install terraform
  displayName: 'Install Latest Terraform'

# 3. Run Terraform Init and Apply
- task: AzureCLI@2
  displayName: 'Terraform Init and Apply'
  inputs:
    azureSubscription: 'AzureConnection' # MUST match your Service Connection name
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    addSpnToEnvironment: true
    inlineScript: |
      # Export credentials for the provider
      export ARM_CLIENT_ID=$servicePrincipalId
      export ARM_CLIENT_SECRET=$servicePrincipalKey
      export ARM_TENANT_ID=$tenantId
      export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)

      echo "Initializing Terraform with Backend..."
      # We inject the backend config here so we don't hardcode secrets in main.tf
      terraform init \
        -backend-config="resource_group_name=$(bk_resource_group)" \
        -backend-config="storage_account_name=$(bk_storage_account)" \
        -backend-config="container_name=$(bk_container_name)" \
        -backend-config="key=$(bk_key)" \
        -input=false

      echo "Planning Terraform..."
      terraform plan -out=tfplan -input=false

      echo "Applying Terraform..."
      terraform apply -auto-approve tfplan -input=false