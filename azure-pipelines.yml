trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

steps:
# 1. Install Terraform on the runner
- task: TerraformInstaller@0
  inputs:
    terraformVersion: 'latest'

# 2. Initialize Terraform (Downloads the Azure plugin)
- task: TerraformTaskV4@4
  displayName: 'Terraform Init'
  inputs:
    provider: 'azurerm'
    command: 'init'
    backendServiceArm: 'AzureConnection' # Matches the name you created in Part 3
    backendAzureRmResourceGroupName: 'gopal-storage-RG' # Create this manually in Azure Portal first if you want to save state, or leave dummy for local test
    backendAzureRmStorageAccountName: 'gopalstorage123' # Dummy for local test
    backendAzureRmContainerName: 'tfstate'
    backendAzureRmKey: 'terraform.tfstate'

# Note: For a simple assignment without remote state storage, 
# we can use a script instead of the official task to skip backend requirement:

- script: |
    terraform init
    terraform plan -out=main.tfplan
  displayName: 'Terraform Init & Plan'
  env:
    ARM_SUBSCRIPTION_ID: $(az account show --query id -o tsv) 
    # Note: For the script to work, we need to log in. 
    # The easier way for beginners is using the "TerraformTaskV4" with a Service Connection.
    # Let's use the simplest verified block below:

# SIMPLIFIED BLOCK FOR ASSIGNMENT (Copy this part)
- task: TerraformTaskV4@4
  displayName: 'Terraform Init'
  inputs:
    provider: 'azurerm'
    command: 'init'
    backendServiceArm: 'AzureConnection'
    backendAzureRmResourceGroupName: '' # Leave empty to use local state (ephemeral)
    backendAzureRmStorageAccountName: ''
    backendAzureRmContainerName: ''
    backendAzureRmKey: ''

- task: TerraformTaskV4@4
  displayName: 'Terraform Apply'
  inputs:
    provider: 'azurerm'
    command: 'apply'
    environmentServiceNameAzureRM: 'AzureConnection'