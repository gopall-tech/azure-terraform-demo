trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

steps:
# 1. Install Terraform
- script: |
    sudo apt-get update && sudo apt-get install -y gnupg software-properties-common
    wget -O- https://apt.releases.hashicorp.com/gpg | \
    gpg --dearmor | \
    sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg
    echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] \
    https://apt.releases.hashicorp.com $(lsb_release -cs) main" | \
    sudo tee /etc/apt/sources.list.d/hashicorp.list
    sudo apt-get update && sudo apt-get install terraform
  displayName: 'Install Latest Terraform'

# 2. Run Terraform inside the Azure CLI Task (Fixes the login error)
- task: AzureCLI@2
  displayName: 'Terraform Init and Apply'
  inputs:
    azureSubscription: 'AzureConnection' # MUST match your Service Connection name
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    addSpnToEnvironment: true
    inlineScript: |
      # These lines pass the Service Connection credentials to Terraform
      export ARM_CLIENT_ID=$servicePrincipalId
      export ARM_CLIENT_SECRET=$servicePrincipalKey
      export ARM_TENANT_ID=$tenantId
      export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)

      echo "Initializing Terraform..."
      terraform init

      echo "Applying Terraform..."
      terraform apply -auto-approve